<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Files - Extract DNI, IBAN & Full Name</title>
  <style>
    #custom-upload {
      background: #eee;
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      display: inline-block;
      margin-right: 10px;
    }
    #imageInput {
      display: none;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body>
  <h2>Upload screenshots or PDFs</h2>
  <label id="custom-upload" for="imageInput">Select files</label>
  <input type="file" id="imageInput" accept="image/*,.pdf" multiple />
  <button onclick="processImage()">Process Files</button>
  <pre id="output"></pre>

  <script>
    async function processImage() {
      const fileInput = document.getElementById("imageInput");
      const files = Array.from(fileInput.files);

      if (!files.length) return alert("Please upload at least one file");

      const allItems = [];

      for (const file of files) {
        if (file.type === "application/pdf") {
          const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: context, viewport }).promise;
            const dataUrl = canvas.toDataURL("image/png");
            const result = await extractDataFromImage(dataUrl);
            allItems.push(result);
          }
        } else {
          const reader = new FileReader();
          await new Promise((resolve) => {
            reader.onloadend = async () => {
              const dataUrl = reader.result;
              const result = await extractDataFromImage(dataUrl);
              allItems.push(result);
              resolve();
            };
            reader.readAsDataURL(file);
          });
        }
      }

      document.getElementById("output").textContent = JSON.stringify(allItems, null, 2);

      await fetch("https://valeriahr.app.n8n.cloud/webhook/ocr-banc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(allItems),
      });
    }

    async function extractDataFromImage(dataUrl) {
      const base64Image = dataUrl.split(',')[1];

      const visionResponse = await fetch(
        `https://vision.googleapis.com/v1/images:annotate?key=AIzaSyAfBhyUdj_js7hZYDKO75SwHgkM46Lp5-Q`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            requests: [
              {
                image: { content: base64Image },
                features: [{ type: "TEXT_DETECTION", maxResults: 1 }],
              },
            ],
          }),
        }
      );

      const visionData = await visionResponse.json();
      const fullText = visionData.responses[0]?.fullTextAnnotation?.text || "";

      // Normalizar texto para facilitar búsqueda
      const normalizedText = fullText.replace(/\s+/g, ' ').toUpperCase();

      // Extraer IBAN
      const ibanRawMatch = normalizedText.match(/ES[\d\s\-]{20,}/i);
      const iban = ibanRawMatch
        ? ibanRawMatch[0].replace(/[^A-Z0-9]/gi, '').trim()
        : "Not found";

      // Extraer DNI/NIE (tolerante a espacios)
      const dniMatch = normalizedText.match(/\b([XYZ]?\s*\d{7,8}\s*[A-Z])\b/);
      const dni = dniMatch
        ? dniMatch[1].replace(/\s+/g, '').toUpperCase()
        : "Not found";

      // Extraer nombre completo tras "titular a D." o similares
      let fullName = "Not found";
      const nameMatch = normalizedText.match(/TITULAR(?:IDAD)?(?:.*?)D[\.ª]?\s+([A-ZÁÉÍÓÚÑ]+\s+[A-ZÁÉÍÓÚÑ]+\s+[A-ZÁÉÍÓÚÑ]+)/);
      if (nameMatch) {
        fullName = nameMatch[1].trim();
      }

      return {
        iban,
        dni,
        fullName
      };
    }
  </script>
</body>
</html>


